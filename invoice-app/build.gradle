plugins {
    id("java")
    id("idea")
    id ("com.google.protobuf") version "0.8.19"
    id ("io.github.lognet.grpc-spring-boot") version "5.1.4"
}


repositories {
    mavenCentral()
}

ext {
    set('testcontainersVersion', "1.18.3")
}

dependencies {
    runtimeOnly ("io.grpc:grpc-netty-shaded:1.58.0")
    implementation ("io.grpc:grpc-protobuf:1.58.0")
    implementation ("io.grpc:grpc-stub:1.58.0")
    implementation("com.google.protobuf:protobuf-java:3.22.3")
    compileOnly ("org.apache.tomcat:annotations-api:6.0.53") // necessary for Java 9+
    implementation("org.mongodb:mongodb-driver-sync:4.10.2")
    implementation("org.mongodb:mongodb-driver-reactivestreams:4.10.2")
    implementation("org.springframework.boot:spring-boot-starter-data-mongodb:3.1.2")
    implementation("org.slf4j:slf4j-api:1.7.32")
    implementation("ch.qos.logback:logback-classic:1.2.9")
    implementation 'org.springframework.boot:spring-boot-starter-web:3.1.4'
    implementation("org.springframework.boot:spring-boot-starter-data-mongodb:3.1.2")
    implementation("org.springframework.boot:spring-boot-starters:2.1.2.RELEASE")
    implementation("org.springframework.boot:spring-boot-starter-websocket:3.1.2")
    implementation("org.mapstruct:mapstruct:1.4.2.Final")
    compileOnly("org.projectlombok:lombok:1.18.30")
    annotationProcessor("org.projectlombok:lombok:1.18.28")
    annotationProcessor("org.mapstruct:mapstruct-processor:1.4.2.Final")
    // JUnit-Test-Framework
    testImplementation(platform("org.junit:junit-bom:5.9.1"))
    testImplementation("org.junit.jupiter:junit-jupiter:5.9.3")
    testImplementation("org.junit.jupiter:junit-jupiter-api:5.10.0")
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine:5.9.3")
    // Grpc-Test-Support
    testImplementation("io.grpc:grpc-testing:1.56.1")
    // Spring-Test-Support (Optional)
    testImplementation("org.springframework.boot:spring-boot-starter-test:3.1.4")
}


tasks.named('test') {
    useJUnitPlatform()
}

sourceSets {
    main {
        java {
            srcDirs 'build/generated/source/proto/main/grpc'
            srcDirs 'build/generated/source/proto/main/java'
        }
    }
}

protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.10.1'
    }

    plugins {
        grpc {
            artifact = 'io.grpc:protoc-gen-grpc-java:1.25.0'
        }
    }

    generateProtoTasks {
        all()*.plugins {
            grpc {}
        }
    }
}